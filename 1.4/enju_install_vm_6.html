

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第6章 検索エンジンの設定 - Next-L Enju インストールマニュアル（Docker編）</title>
    
    <meta name="author" content="Project Next-L">

    <!-- Le styles -->
    <link href="https://next-l.github.io/documentation/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://next-l.github.io/documentation/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="https://next-l.github.io/documentation/assets/themes/twitter/css/enju.css" rel="stylesheet" type="text/css" media="all">
    <link href="https://next-l.github.io/documentation/assets/themes/twitter/css/enju-manual-patch.css" rel="stylesheet" type="text/css" media="all">
    <link href="https://next-l.github.io/documentation/assets/themes/twitter/css/highlight.css" rel="stylesheet" type="text/css" media="all">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="https://next-l.github.io/documentation"><img src="https://next-l.github.io/documentation/assets/themes/twitter/../../images/logo.gif" alt="" />Documentation for Next-L Enju 1.4</a>
          <ul class="nav">
            
            
            


  
  
    
    
    
      
      	
      	<li><a href="https://next-l.github.io/documentation/1.4/enju_install_vm.html">インストール</a></li>
      	
      
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  

  

  
    
    
    
      
      	
      	<li><a href="https://next-l.github.io/documentation/1.4/enju_operation.html">運用</a></li>
      	
      
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  

  
    
    
    
      
      	
      	<li><a href="https://next-l.github.io/documentation/1.4/enju_setup.html">初期設定</a></li>
      	
      
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  

  
    
    
    
      
      	
      	<li><a href="https://next-l.github.io/documentation/1.4/enju_user.html">利用</a></li>
      	
      
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  
    
    
    
  

  

  
    
    
    
      
      	
      	<li><a href="https://next-l.github.io/documentation/1.4/enju_webapi.html">Web API</a></li>
      	
      
    
  

  
    
    
    
  

  

  

  

  

  
    
    
    
  

  
    
    
    
  








          </ul>
          <script async src="https://cse.google.com/cse.js?cx=010401064499935159628:008mzix-v_g"></script>
<div class="gcse-search"></div>

        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="content">
        

<div class="page-header">
  <h1>第6章 検索エンジンの設定 - Next-L Enju インストールマニュアル（Docker編） </h1>
</div>
<div class="row-fluid">
  <div class="span12">
    <div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#検索における異体字の同一視">検索における異体字の同一視</a>
<ul class="sectlevel2">
<li><a href="#異体字を同一視するようにsolrを設定する">異体字を同一視するようにSolrを設定する</a></li>
<li><a href="#異体字の考え方">異体字の考え方</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="検索における異体字の同一視">検索における異体字の同一視</h2>
<div class="sectionbody">
<div class="paragraph">
<p>書誌情報には「森鷗外／鴎外」「内田百閒／百間」「芥川龍之介／竜之介」のように、さまざまな異体字が混在しています。
これらを別字として扱ってしまうと大量の検索漏れが生じるので、検索においては「鷗」と「鴎」を同一視する必要があります。</p>
</div>
<div class="paragraph">
<p>検索時に異体字を同一視させるためには、検索エンジン側でその設定を行わなければなりません。
本章ではEnjuと連携して動作する全文検索エンジンApache Solrにおける設定手順を説明します。</p>
</div>
<div class="sect2">
<h3 id="異体字を同一視するようにsolrを設定する">異体字を同一視するようにSolrを設定する</h3>
<div class="paragraph">
<p>SolrのCharFilterという機能を使えば異体字を同一視して検索させることができます。</p>
</div>
<div class="paragraph">
<p>例えば「島」「嶋」「嶌」を検索上同一視させたいとします。その場合、代表の文字を一つ、例えば「島」と決めます。そして、「嶋」「嶌」を「島」に変換するような設定を行います。</p>
</div>
<div class="paragraph">
<p>するとSolrは、書誌情報から検索用データを作成する際に、「嶋」「嶌」を「島」に変換します。</p>
</div>
<div class="paragraph">
<p>また、検索を行う際も、検索語の中の「嶋」「嶌」を「島」に変換します。</p>
</div>
<div class="paragraph">
<p>これにより、「大嶋」で「大島」も「大嶌」もヒットするようになります。</p>
</div>
<div class="sect3">
<h4 id="マッピングファイルを作成">マッピングファイルを作成</h4>
<div class="paragraph">
<p>以下のような形式のマッピングファイルを作ります。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>"嶋" =&gt; "島"
"嶌" =&gt; "島"</pre>
</div>
</div>
<div class="paragraph">
<p>文字コードは UTF-8、改行は LF とします。ファイル名は例えば ja-variants.txt など好きなように付けます。</p>
</div>
<div class="paragraph">
<p>ナンバー記号（<code>#</code>）で始まる行はコメントとみなされます。しかし、以下のような形式のコメントは許されません。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>"嶋" =&gt; "島" # コメント（これはダメ）</pre>
</div>
</div>
<div class="paragraph">
<p>「<code>&#8658;</code>」の前後のスペースは略すこともできます。</p>
</div>
<div class="paragraph">
<p>Unicodeのコード番号で文字を指定することもできます。4桁の16進数で <code><code>\uXXXX</code></code> のように書きます。</p>
</div>
<div class="paragraph">
<p>4桁で表せるのは、Unicode の基本多言語面（BMP: Basic Multilingual Plane）内の文字だけです。BMP外の文字は5桁ないし6桁になりますので、この形式は使えません。文字そのものをじかに書く必要があります。BMP外には、「𡈽」（U+2123D）、「𠀋」（U+2000B）のようなありふれた異体字もあります。</p>
</div>
<div class="paragraph">
<p>変換元、変換先は2文字以上書くこともできます。よって、</p>
</div>
<div class="literalblock">
<div class="content">
<pre>"麿" =&gt; "麻呂"
"\u5715" =&gt; "図書館"
"\u309F" =&gt; "より"</pre>
</div>
</div>
<div class="paragraph">
<p>と書いておけば、</p>
</div>
<div class="ulist">
<ul>
<li>
<p>「人麿」で「柿本人麻呂」が</p>
</li>
<li>
<p>「図書館用品」で「圕用品研究」が</p>
</li>
<li>
<p>「善藏より聞覚」で「御大工棟梁善藏ゟ聞覚控」が</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>検索できるようになります。（「圕」〔U+5715〕は図書館学者の杜定友による1926年頃の造字で「圖書館」を一字にしたもの；「ゟ」〔U+309F〕は「より」の合字）</p>
</div>
<div class="paragraph">
<p>変換元は空文字列にできませんが、変換先は空文字列を指定することができます。</p>
</div>
</div>
<div class="sect3">
<h4 id="マッピングファイルを配置">マッピングファイルを配置</h4>
<div class="paragraph">
<p>Enju インストールディレクトリーの下に solr/conf があります。</p>
</div>
<div class="paragraph">
<p>前節で作成したマッピングファイルをここに入れておきます。</p>
</div>
</div>
<div class="sect3">
<h4 id="設定ファイルにファイル名を書く">設定ファイルにファイル名を書く</h4>
<div class="paragraph">
<p>solr/conf ディレクトリーの中に schema.xml というXMLファイルがあります。</p>
</div>
<div class="paragraph">
<p>このXMLに <code>fieldType[name="text"]</code> という要素があり、その直下に <code>analyzer</code> という要素があります。その内容に、以下のように <code>charFilter</code> 要素を追加します。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;fieldType name="text" class="solr.TextField" omitNorms="false"&gt;
  &lt;analyzer&gt;
    &lt;charFilter class="solr.MappingCharFilterFactory" mapping="ja-variants.txt" /&gt;</pre>
</div>
</div>
<div class="paragraph">
<p><code>mapping</code> 属性にファイル名を指定します。</p>
</div>
<div class="paragraph">
<p>ファイル名は</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;charFilter class="solr.MappingCharFilterFactory" mapping="vars1.txt,vars2.txt"/&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>のようにカンマ区切りで複数指定することもできます。</p>
</div>
<div class="paragraph">
<p>複数ファイルに異体字マッピングファイルを分けておくと、たとえば、a) 確かな典拠に基づくメインファイルと、b) 館の都合に合わせて追加／修正するカスタマイズファイル、といったようにファイルを分割管理することもできます。</p>
</div>
<div class="paragraph">
<p>また、漢字の異体字とラテン文字の置き換え（「æ」→「ae」など）を別ファイルにする、といった分け方もできます。</p>
</div>
</div>
<div class="sect3">
<h4 id="enjuの再起動とsolrの再インデックス">Enjuの再起動とSolrの再インデックス</h4>
<div class="paragraph">
<p>設定が終わったら、設定を反映するために、Enju を再起動（リスタート）して、書誌情報を再度インデックスします。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker compose down
docker compose up -d
docker compose run --rm web rake sunspot:reindex RAILS_ENV=production</pre>
</div>
</div>
<div class="paragraph">
<p>これで異体字でも検索ができるようになるはずです。</p>
</div>
</div>
<div class="sect3">
<h4 id="参考サイト">参考サイト</h4>
<div class="paragraph">
<p>[<a href="https://cwiki.apache.org/confluence/display/solr/CharFilterFactories#CharFilterFactories-solr.MappingCharFilterFactory" class="bare">https://cwiki.apache.org/confluence/display/solr/CharFilterFactories#CharFilterFactories-solr.MappingCharFilterFactory</a>](<a href="https://cwiki.apache.org/confluence/display/solr/CharFilterFactories#CharFilterFactories-solr.MappingCharFilterFactory" class="bare">https://cwiki.apache.org/confluence/display/solr/CharFilterFactories#CharFilterFactories-solr.MappingCharFilterFactory</a>)</p>
</div>
<div class="paragraph">
<p>上記ページにCharFilterの仕様などが詳しく書かれています。公式サイトです。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="異体字の考え方">異体字の考え方</h3>
<div class="paragraph">
<p>異体字のマッピングファイルを作るにあたって注意すべきことなどを述べます。</p>
</div>
<div class="sect3">
<h4 id="時代性">時代性</h4>
<div class="paragraph">
<p>現在、「著」と「着」は別字であり、「著しい」「著す」「著作」／「着る」「着く」「着信」などと使い分け、交換できません。</p>
</div>
<div class="paragraph">
<p>しかし「着」はもともと「著」の異体字でした。幸田文に「著物」という作品があり、もっと時代の新しい三島由紀夫も作品中で「著る」を使っています。</p>
</div>
<div class="paragraph">
<p>また、「丼」はもともと「井」の異体字ですが、現在ではドンブリの意味でしかふつう使いません。これを異体字として扱うと、天井（てんじょう）を調べていて天丼（てんどん）が出てくることになります。</p>
</div>
<div class="paragraph">
<p>このように、ある二つの漢字が異体字であるかどうかはそれが使われた時代によって変わります。</p>
</div>
</div>
<div class="sect3">
<h4 id="異体字のような別字">異体字のような別字</h4>
<div class="paragraph">
<p>「斉」と「齊」は異体字の関係にあります。「斎」と「齋」もそうです。しかし、「斉・齊」と「斎・齋」とは別字です。「書斎」は「書斉」とは書けず、「一斉」は「一斎」とは書けません。</p>
</div>
<div class="paragraph">
<p>とはいえ、人名（サイトウ）に限って言えばこの四字は異体字のように使われており、異体字だと思っているサイトウさんも少なくないようです。</p>
</div>
<div class="paragraph">
<p>検索上は異体字かどうかに拘泥せず、この四字を同一視するのがよいかもしれません。</p>
</div>
</div>
<div class="sect3">
<h4 id="代用漢字">代用漢字</h4>
<div class="paragraph">
<p>「国際連盟」「連合艦隊」はそれが存在した時代には「國際聯盟」「聯合艦隊」と書かれていました。しかし、「聯」は「連」の異体字ではありません。</p>
</div>
<div class="paragraph">
<p>この場合の「連」は、当用漢字に含まれなかった「聯」を、同音で意味的にもあまり無理のない当用漢字の別字に置き換えたものです。</p>
</div>
<div class="paragraph">
<p>このような置き換え字は「代用漢字」などと呼ばれ、「午后」→「午後」、「遵守」→「順守」、「附録」→「付録」、「蒐集」→「収集」、「編輯」→「編集」、「沙漠」→「砂漠」、「日蝕」→「日食」、「訊問」→「尋問」、「脈搏」→「脈拍」、「叛乱」→「反乱」、「扮飾」→「粉飾」、「長篇」→「長編」、「哺育」→「保育」、「繃帯」→「包帯」、「抛物線」→「放物線」、「彎曲」→「湾曲」など多数あります。</p>
</div>
<div class="paragraph">
<p>こういったものも異体字のように扱うかべきどうかは場合によるでしょう。</p>
</div>
<div class="paragraph">
<p>単語単位で「午后」を「午後」に変換するのでなく文字単位で「后」を「後」に変換する場合，「后」（きさき）による検索で大量の検索ノイズが発生するかもしれません。</p>
</div>
</div>
<div class="sect3">
<h4 id="中国語の簡体字">中国語の簡体字</h4>
<div class="paragraph">
<p>中国の「広東省」は簡体字で「广东省」と書きます。「广」／「広」、「东」／「東」は異体字の関係にあるので、このペアもマッピングファイルに入れておけば、中国語の書誌情報も手軽に検索できてすこぶる便利ではないでしょうか。</p>
</div>
<div class="paragraph">
<p>ところが、そう簡単ではありません。</p>
</div>
<div class="paragraph">
<p>「機」の簡体字は「机」です。「葉」は「叶」、「幹」は「干」です。このように、中国語では異体字であるものが、日本語では全くの別字ということがあるのです。</p>
</div>
<div class="paragraph">
<p>このように、どの字とどの字が異体字の関係になるかは、言語によっても異なります。</p>
</div>
</div>
<div class="sect3">
<h4 id="検索ノイズとの兼ね合い">検索ノイズとの兼ね合い</h4>
<div class="paragraph">
<p>上で見たように，異体字マッピングを拡充すれば検索漏れが減らせる一方で検索ノイズが増えることがあります。再現率（検索漏れの少なさ）と適合率（検索ノイズの少なさ）は一般にはトレードオフの関係にあります。</p>
</div>
<div class="paragraph">
<p>そのため，資料群の特性を考えて異体字の範囲を定める必要があるでしょう。</p>
</div>
<div class="paragraph">
<p>もう一つ検討すべきことは，検索ノイズにも利用者を悩ませるものとそれほどでもないものがあることです。</p>
</div>
<div class="paragraph">
<p>異体字の例ではありませんが，「国語辞典」で検索して「中国語辞典」までヒットした場合，利用者はなぜそのような検索ノイズが生じたのか，たいてい理解できます。</p>
</div>
<div class="paragraph">
<p>しかし，アガサ・クリスティーに「機上のナントカ」（『機上の死』）があったと思って「機上」で検索したら『ナントカ辞典机上版』の類がどっと出てきた，という場合，中国語を学んだことのない利用者には理解不能です。</p>
</div>
<div class="paragraph">
<p>叶（かのう）さんの著作を検索したら樋口一葉の作品まで出てきた。これも同様です。</p>
</div>
<div class="paragraph">
<p>自分の操作が悪いのか，システムの不具合なのか。利用者に無用のストレスを与えることになります。</p>
</div>
<div class="paragraph">
<p>蔵書構成だけでなく，利用者層の特性も考慮して決めるとよいでしょう。</p>
</div>
<div class="paragraph">
<p>なお，異体字対策については，検索機能でなくデータ側で頑張る方針もあります。異体字の範囲はほどほどにとどめ，書誌情報に異表記を積極的に追加して再現率を上げるやり方です。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="enju_install_vm_1.html">第1章 Enju概要</a></p>
</li>
<li>
<p><a href="enju_install_vm_2.html">第2章 Enjuを動作させる方法</a></p>
</li>
<li>
<p><a href="enju_install_vm_3.html">第3章 動作環境の確認とDockerのインストール</a></p>
</li>
<li>
<p><a href="enju_install_vm_4.html">第4章 Enjuのインストール</a></p>
</li>
<li>
<p><a href="enju_install_vm_5.html">第5章 モジュールの追加</a></p>
</li>
<li>
<p><a href="enju_install_vm_6.html">第6章 検索エンジンの設定</a></p>
</li>
<li>
<p><a href="enju_install_vm_7.html">第7章 他のコンピュータからの利用設定</a></p>
</li>
<li>
<p><a href="enju_install_vm_8.html">第8章 Enjuのアップデート</a></p>
</li>
<li>
<p><a href="enju_install_vm_9.html">第9章 データのバックアップ</a></p>
</li>
<li>
<p><a href="enju_install_vm_10.html">第10章 その他（カスタマイズなど）</a></p>
</li>
<li>
<p><a href="enju_install_vm_11.html">第11章 トラブルシューティング</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
  </div>
</div>


      </div>

      <footer>
        <p>&copy; 2007-2023 <a href="https://www.next-l.jp">Project Next-L</a></p>
      </footer>

    </div> <!-- /container -->

    
    
  <script type="text/javascript">
  $(function() {
    return $("h2, h3, h4, h5, h6").each(function(i, el) {
      var $el, icon, id;
      $el = $(el);
      id = $el.attr('id');
      icon = '<i title="Permalink to this section" class="fa fa-share-alt"></i>';
      if (id) {
        return $el.append($("<a />").addClass("header-link").attr("href", "#" + id).html(icon));
      }
    });
  });
  </script>
    
  </body>
</html>

